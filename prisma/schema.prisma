generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── NextAuth ─────────────────────────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

// ─── Property & Unit ───────────────────────────────────────────────────────

model Property {
  id           String   @id @default(cuid())
  address      String
  city         String
  state        String
  zip          String
  jurisdiction String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  units        Unit[]
  showings     Showing[]
  events       Event[]
  utilityBills UtilityBill[]
}

enum UnitStatus {
  VACANT
  OCCUPIED
  MAINTENANCE
}

model Unit {
  id         String     @id @default(cuid())
  name       String
  propertyId String
  status     UnitStatus @default(VACANT)
  rentAmount Float?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  property             Property             @relation(fields: [propertyId], references: [id])
  leases               Lease[]
  tenants              Tenant[]
  cleaningAssignments  CleaningAssignment[]

  @@index([propertyId])
}

// ─── Tenant ────────────────────────────────────────────────────────────────

model Tenant {
  id         String   @id @default(cuid())
  firstName  String
  lastName   String
  email      String?
  phone      String?
  facebookId String?
  unitId     String?
  active     Boolean  @default(true)
  deletedAt  DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  unit                 Unit?                @relation(fields: [unitId], references: [id])
  leases               Lease[]
  payments             Payment[]
  ledgerEntries        LedgerEntry[]
  messages             Message[]
  notices              Notice[]
  applications         Application[]
  cleaningAssignments  CleaningAssignment[]
  events               Event[]

  @@index([unitId])
  @@index([email])
  @@index([phone])
  @@index([facebookId])
}

// ─── Lease ─────────────────────────────────────────────────────────────────

model LeaseTemplate {
  id          String   @id @default(cuid())
  name        String
  content     String
  description String?
  jurisdiction String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  leases Lease[]
}

enum LeaseStatus {
  DRAFT
  PENDING_SIGNATURE
  ACTIVE
  EXPIRED
  TERMINATED
}

model Lease {
  id        String      @id @default(cuid())
  tenantId  String
  unitId    String
  templateId String?
  status    LeaseStatus @default(DRAFT)
  content   String
  rentAmount Float?
  version   Int         @default(1)
  startDate DateTime
  endDate   DateTime?
  signedAt  DateTime?
  signedDocumentUrl String?
  xodoSignDocumentId String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  tenant   Tenant         @relation(fields: [tenantId], references: [id])
  unit     Unit           @relation(fields: [unitId], references: [id])
  template LeaseTemplate? @relation(fields: [templateId], references: [id])
  clauses  LeaseClause[]

  @@index([tenantId])
  @@index([unitId])
  @@index([templateId])
}

model LeaseClause {
  id       String @id @default(cuid())
  leaseId  String
  type     String
  content  String
  metadata Json?
  createdAt DateTime @default(now())

  lease Lease @relation(fields: [leaseId], references: [id])

  @@index([leaseId])
}

// ─── Event (Immutable) ─────────────────────────────────────────────────────

enum EventType {
  MESSAGE
  PAYMENT
  NOTICE
  UPLOAD
  VIOLATION
  INSPECTION
  SYSTEM
  LEASE
  APPLICATION
  SHOWING
  CLEANING
}

model Event {
  id         String    @id @default(cuid())
  type       EventType
  tenantId   String?
  propertyId String?
  payload    Json
  createdAt  DateTime  @default(now())

  tenant   Tenant?   @relation(fields: [tenantId], references: [id])
  property Property? @relation(fields: [propertyId], references: [id])

  @@index([tenantId])
  @@index([propertyId])
  @@index([type])
  @@index([createdAt])
}

// ─── Payment & Ledger ──────────────────────────────────────────────────────

enum PaymentMethod {
  ZELLE
  VENMO
  CASHAPP
  PAYPAL
  CASH
  CHECK
}

model Payment {
  id        String        @id @default(cuid())
  tenantId  String
  amount    Float
  method    PaymentMethod
  date      DateTime
  note      String?
  createdAt DateTime      @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([date])
}

enum LedgerEntryType {
  RENT
  LATE_FEE
  UTILITY
  DEPOSIT
  CREDIT
  PAYMENT
  DEDUCTION
}

model LedgerEntry {
  id          String          @id @default(cuid())
  tenantId    String
  type        LedgerEntryType
  amount      Float
  description String?
  period      String?
  balance     Float
  createdAt   DateTime        @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([period])
}

// ─── Message ───────────────────────────────────────────────────────────────

enum MessageChannel {
  SMS
  EMAIL
  FACEBOOK
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

model Message {
  id        String           @id @default(cuid())
  tenantId  String?
  channel   MessageChannel
  direction MessageDirection
  content   String
  metadata  Json?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([channel])
  @@index([createdAt])
}

// ─── Notice ────────────────────────────────────────────────────────────────

enum NoticeType {
  LATE_RENT
  LEASE_VIOLATION
  EVICTION_WARNING
  DEPOSIT_DISPOSITION
  MOVE_OUT
}

enum NoticeStatus {
  DRAFT
  SENT
  SERVED
  ACKNOWLEDGED
}

model Notice {
  id              String       @id @default(cuid())
  tenantId        String
  type            NoticeType
  status          NoticeStatus @default(DRAFT)
  content         String
  sentAt          DateTime?
  servedAt        DateTime?
  proofOfService  String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([type])
}

// ─── Showing ───────────────────────────────────────────────────────────────

enum ShowingStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  NO_SHOW
  CANCELLED
}

model Showing {
  id            String        @id @default(cuid())
  propertyId    String
  date          DateTime
  attendeeName  String?
  attendeePhone String?
  attendeeEmail String?
  status        ShowingStatus @default(SCHEDULED)
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  property Property @relation(fields: [propertyId], references: [id])

  @@index([propertyId])
  @@index([date])
}

// ─── Application ───────────────────────────────────────────────────────────

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
}

model Application {
  id             String            @id @default(cuid())
  tenantId       String?
  token          String            @unique @default(cuid())
  status         ApplicationStatus @default(PENDING)
  firstName      String?
  lastName       String?
  email          String?
  phone          String?
  currentAddress String?
  employer       String?
  income         Float?
  rentalHistory  Json?
  evictionHistory Json?
  documents      Json?
  submittedAt    DateTime?
  reviewedAt     DateTime?
  reviewNotes    String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([status])
}

// ─── Utility Bill ─────────────────────────────────────────────────────────

model UtilityBill {
  id           String   @id @default(cuid())
  propertyId   String
  provider     String
  type         String   // electric, gas, water, internet, trash, etc.
  amount       Float
  billingStart DateTime
  billingEnd   DateTime
  period       String   // "YYYY-MM" for the billing period
  allocated    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id])

  @@index([propertyId])
  @@index([period])
}

// ─── Durham Water Parsed Bills ────────────────────────────────────────────

enum DurhamWaterDocType {
  BILL
  DELINQUENCY_NOTICE
  UNKNOWN
}

model DurhamWaterParsedBill {
  id                 String              @id @default(cuid())
  accountNumber      String
  serviceLocation    String
  documentType       DurhamWaterDocType  @default(BILL)
  amountDue          Float
  billDate           DateTime?
  dueDate            DateTime?
  billingPeriodStart DateTime?
  billingPeriodEnd   DateTime?
  disconnectDate     DateTime?
  lastDayToPay       DateTime?
  balanceForward     Float               @default(0)
  waterCharges       Float               @default(0)
  sewerCharges       Float               @default(0)
  requiresAttention  Boolean             @default(false)
  attentionReason    String?
  pdfPath            String?
  matchedPropertyId  String?
  importedToUtilityBillId String?        @unique
  parsedAt           DateTime            @default(now())
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@unique([accountNumber, billingPeriodEnd])
  @@index([accountNumber])
  @@index([matchedPropertyId])
  @@index([requiresAttention])
}

// ─── Duke Energy Parsed Bills ──────────────────────────────────────────────

enum DukeEnergyDocType {
  BILL
  DISCONNECT_NOTICE
  UNKNOWN
}

model DukeEnergyParsedBill {
  id                 String             @id @default(cuid())
  accountNumber      String
  serviceAddress     String
  documentType       DukeEnergyDocType  @default(BILL)
  amountDue          Float
  billDate           DateTime?
  dueDate            DateTime?
  billingPeriodStart DateTime?
  billingPeriodEnd   DateTime?
  billingDays        Int                @default(0)
  kwhUsed            Float              @default(0)
  meterNumber        String?
  electricCharges    Float              @default(0)
  taxes              Float              @default(0)
  previousBalance    Float              @default(0)
  paymentsReceived   Float              @default(0)
  requiresAttention  Boolean            @default(false)
  attentionReason    String?
  pdfPath            String?
  matchedPropertyId  String?
  importedToUtilityBillId String?       @unique
  parsedAt           DateTime           @default(now())
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@unique([accountNumber, billingPeriodEnd])
  @@index([accountNumber])
  @@index([matchedPropertyId])
  @@index([requiresAttention])
}

// ─── Enbridge Gas Parsed Bills ─────────────────────────────────────────────

enum EnbridgeGasDocType {
  BILL
  DISCONNECT_NOTICE
  UNKNOWN
}

model EnbridgeGasParsedBill {
  id                 String              @id @default(cuid())
  accountNumber      String
  serviceAddress     String
  documentType       EnbridgeGasDocType  @default(BILL)
  amountDue          Float
  billDate           DateTime?
  dueDate            DateTime?
  billingPeriodStart DateTime?
  billingPeriodEnd   DateTime?
  billingDays        Int                 @default(0)
  thermsUsed         Float               @default(0)
  meterNumber        String?
  gasCharges         Float               @default(0)
  basicFacilitiesCharge Float            @default(0)
  taxes              Float               @default(0)
  previousBalance    Float               @default(0)
  paymentsReceived   Float               @default(0)
  requiresAttention  Boolean             @default(false)
  attentionReason    String?
  pdfPath            String?
  matchedPropertyId  String?
  importedToUtilityBillId String?        @unique
  parsedAt           DateTime            @default(now())
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@unique([accountNumber, billingPeriodEnd])
  @@index([accountNumber])
  @@index([matchedPropertyId])
  @@index([requiresAttention])
}

// ─── Wake Electric Parsed Bills ─────────────────────────────────────────────

enum WakeElectricDocType {
  BILL
  DISCONNECT_NOTICE
  UNKNOWN
}

model WakeElectricParsedBill {
  id                 String              @id @default(cuid())
  accountNumber      String
  serviceAddress     String
  documentType       WakeElectricDocType @default(BILL)
  amountDue          Float
  billDate           DateTime?
  dueDate            DateTime?
  billingPeriodStart DateTime?
  billingPeriodEnd   DateTime?
  billingDays        Int                 @default(0)
  kwhUsed            Float               @default(0)
  meterNumber        String?
  energyCharge       Float               @default(0)
  facilityCharge     Float               @default(0)
  taxes              Float               @default(0)
  previousBalance    Float               @default(0)
  paymentsReceived   Float               @default(0)
  requiresAttention  Boolean             @default(false)
  attentionReason    String?
  pdfPath            String?
  matchedPropertyId  String?
  importedToUtilityBillId String?        @unique
  parsedAt           DateTime            @default(now())
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@unique([accountNumber, billingPeriodEnd])
  @@index([accountNumber])
  @@index([matchedPropertyId])
  @@index([requiresAttention])
}

// ─── Cleaning Assignment ───────────────────────────────────────────────────

enum CleaningStatus {
  PENDING
  SUBMITTED
  VALIDATED
  FAILED
  OVERDUE
}

model CleaningAssignment {
  id          String         @id @default(cuid())
  tenantId    String
  unitId      String
  token       String         @unique @default(cuid())
  weekOf      DateTime
  status      CleaningStatus @default(PENDING)
  photos      Json?
  validatedAt DateTime?
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  unit   Unit   @relation(fields: [unitId], references: [id])

  @@index([tenantId])
  @@index([unitId])
  @@index([weekOf])
}
